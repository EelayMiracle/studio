<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор математического кроссворда</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.1)), url('img/f1.jpg') center/cover no-repeat;
            z-index: -2;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(110,142,251,0.8), rgba(167,119,227,0.3));
            z-index: -1;
        }
        .game-container {
            margin-top: 40px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.2);
            border: 1px solid rgba(255,255,255,0.18);
            padding: 30px 40px 40px 40px;
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .game-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .game-settings {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .game-settings label {
            font-size: 1em;
            margin-right: 8px;
        }
        .game-settings select, .game-settings input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 14px;
        }
        .game-area {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            position: relative;
            width: 100%;
            min-height: 500px;
        }
        .number-pool {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .number-item {
            background: linear-gradient(135deg, #00c6ff 60%, #a777e3 100%);
            color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(31,38,135,0.10);
            border: 2px solid #fff;
            cursor: grab;
            user-select: none;
            transition: all 0.3s ease;
        }
        .number-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(31,38,135,0.3);
        }
         .number-item.dragging {
             opacity: 0.5;
             transform: scale(0.9);
         }
         .number-item.inactive {
             opacity: 0.3;
             background: rgba(150,150,150,0.5);
             cursor: not-allowed;
         }
         .number-item.inactive:hover {
             transform: none;
             background: rgba(150,150,150,0.5);
         }
        .crossword-container {
            display: grid;
            grid-template-columns: repeat(7, 60px);
            grid-template-rows: repeat(7, 60px);
            gap: 2px;
            background: rgba(255,255,255,0.18);
            border-radius: 12px;
            box-shadow: 0 4px 16px 0 rgba(31,38,135,0.15);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 10px;
            margin: 20px;
        }
        .crossword-cell {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.85);
            border-radius: 8px;
            border: 1.5px solid rgba(255,255,255,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: #222;
            font-weight: bold;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }
        .crossword-cell:hover {
            background: rgba(255,255,255,0.95);
            transform: scale(1.05);
        }
        .crossword-cell.drag-over {
            background: rgba(0,198,255,0.3);
            border-color: #00c6ff;
        }
        .crossword-cell.error {
            background: #ffb3b3 !important;
            border-color: #ff5555 !important;
        }
        .crossword-cell.locked {
            background: rgba(200,200,200,0.7);
            cursor: default;
        }
        .crossword-cell.locked:hover {
            transform: none;
        }
         .crossword-cell.empty {
             background: white !important;
             border: 2px solid #ddd;
             color: #333;
         }
         .crossword-cell.inactive {
             background: rgba(200,200,200,0.3) !important;
             border: 1px solid rgba(150,150,150,0.5);
             cursor: default;
         }
         .crossword-cell.inactive:hover {
             transform: none;
             background: rgba(200,200,200,0.3) !important;
         }
        .crossword-cell.operator {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #fff;
            font-weight: bold;
            font-size: 1.5em;
        }
         .crossword-cell.equals {
             background: linear-gradient(135deg, #4CAF50, #45a049);
             color: #fff;
             font-weight: bold;
             font-size: 1.5em;
         }
         .crossword-cell.answer {
             background: linear-gradient(135deg, #ff6b6b, #ffa500);
             color: #fff;
             font-weight: bold;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
         }
        .back-button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 24px;
            border-radius: 50%;
            text-decoration: none;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
        }
        .back-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #00c6ff, #a777e3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(31,38,135,0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(31,38,135,0.4);
        }
        .game-message {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
            min-height: 30px;
            text-align: center;
        }
        .victory-message {
            color: #4CAF50;
            font-size: 24px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
         .crossword-wrapper {
             display: flex;
             gap: 30px;
             align-items: flex-start;
             justify-content: center;
         }
         .answer-container {
             display: flex;
             align-items: flex-start;
         }
         .answer-container .crossword-container {
             opacity: 0;
             transition: opacity 0.3s ease;
         }
         .answer-container.visible .crossword-container {
             opacity: 1;
         }
        @media (max-width: 900px) {
            .game-area { width: 100vw; min-width: 0; }
            .crossword-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .crossword-container {
                grid-template-columns: repeat(7, 50px);
                grid-template-rows: repeat(7, 50px);
            }
            .crossword-cell {
                width: 50px;
                height: 50px;
                font-size: 1.1em;
            }
        }
        @media (max-width: 700px) {
            .game-container { padding: 10px; }
            .game-area { flex-direction: column; align-items: center; width: 100vw; }
            .crossword-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .crossword-container {
                grid-template-columns: repeat(7, 40px);
                grid-template-rows: repeat(7, 40px);
            }
            .crossword-cell {
                width: 40px;
                height: 40px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-title">Генератор математического кроссворда <a href="index.html" class="back-button">←</a></div>
        
         <div class="game-settings">
             <label>Диапазон для + и - (мин):
                 <input type="number" id="addSubMin" value="2" min="1" max="20">
             </label>
             <label>Диапазон для + и - (макс):
                 <input type="number" id="addSubMax" value="9" min="1" max="20">
             </label>
             <label>Диапазон для × (мин):
                 <input type="number" id="multMin" value="2" min="1" max="20">
             </label>
             <label>Диапазон для × (макс):
                 <input type="number" id="multMax" value="6" min="1" max="20">
             </label>
         </div>
        
        <div class="controls">
            <button id="newGameBtn">Новая игра</button>
            <button id="checkBtn" style="display: none;">Проверить</button>
            <button id="showAnswerBtn" style="display: none;">Показать ответ</button>
        </div>
        
        <div class="game-message" id="gameMessage">Нажмите "Новая игра" чтобы начать!</div>
        
        <div class="game-area" id="gameArea" style="display: none;">
            <div class="number-pool" id="numberPool"></div>
            <div class="crossword-wrapper">
                <div class="crossword-container" id="crosswordContainer"></div>
                <div class="answer-container" id="answerContainer">
                    <div class="crossword-container" id="answerCrossword"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Переменные игры
        let gameState = {
            crossword: [],
            solution: [],
            usedNumbers: [],
            availableNumbers: [],
            isGameActive: false,
            addSubRange: {min: 2, max: 9},
            multRange: {min: 2, max: 6}
        };

         // Элементы DOM
         const addSubMinInput = document.getElementById('addSubMin');
         const addSubMaxInput = document.getElementById('addSubMax');
         const multMinInput = document.getElementById('multMin');
         const multMaxInput = document.getElementById('multMax');
        const gameMessage = document.getElementById('gameMessage');
        const gameArea = document.getElementById('gameArea');
        const numberPool = document.getElementById('numberPool');
        const crosswordContainer = document.getElementById('crosswordContainer');
        const answerContainer = document.getElementById('answerContainer');
        const answerCrossword = document.getElementById('answerCrossword');
        const newGameBtn = document.getElementById('newGameBtn');
        const checkBtn = document.getElementById('checkBtn');
        const showAnswerBtn = document.getElementById('showAnswerBtn');

         // Инициализация игры
         function initGame() {
             // Получаем диапазоны из полей ввода
             const addSubMin = parseInt(addSubMinInput.value);
             const addSubMax = parseInt(addSubMaxInput.value);
             const multMin = parseInt(multMinInput.value);
             const multMax = parseInt(multMaxInput.value);
             
             gameState.addSubRange = {min: addSubMin, max: addSubMax};
             gameState.multRange = {min: multMin, max: multMax};
            
            // Генерируем кроссворд
            generateCrossword();
            
            // Создаем игровое поле
            createGameField();
            
             // Показываем элементы
             gameArea.style.display = 'block';
             checkBtn.style.display = 'inline-block';
             showAnswerBtn.style.display = 'inline-block';
             answerContainer.classList.remove('visible');
            
            gameState.isGameActive = true;
            gameMessage.textContent = "Заполните кроссворд числами!";
        }

         // Генерация кроссворда
         function generateCrossword() {
             const { addSubRange, multRange } = gameState;
             
             // Создаем пустую сетку 7x7
             gameState.crossword = Array.from({length: 7}, () => Array(7).fill(''));
             gameState.solution = Array.from({length: 7}, () => Array(7).fill(''));
             
             // Генерируем простой кроссворд без пересечений
             generateSimpleCrossword();
         }

        // Генерация простого кроссворда без пересечений
        function generateSimpleCrossword() {
            const { addSubRange, multRange } = gameState;
            
            // Сначала генерируем горизонтальные уравнения (строки 0, 2, 4)
            const horizontalEquations = [];
            for (let row = 0; row < 3; row++) {
                // Случайно выбираем формат уравнения
                const useMultFirst = Math.random() < 0.5; // true для a * b +- c, false для a +- b * c
                let op1, op2;
                
                if (useMultFirst) {
                    op1 = '*';
                    op2 = Math.random() < 0.5 ? '+' : '-';
                } else {
                    op1 = Math.random() < 0.5 ? '+' : '-';
                    op2 = '*';
                }
                
                const equation = generateNumbersForEquation(op1, op2, addSubRange, multRange);
                horizontalEquations.push(equation);
                
                // Размещаем горизонтальное уравнение
                const actualRow = row * 2;
                gameState.crossword[actualRow][0] = equation.a;
                gameState.crossword[actualRow][1] = equation.op1;
                gameState.crossword[actualRow][2] = equation.b;
                gameState.crossword[actualRow][3] = equation.op2;
                gameState.crossword[actualRow][4] = equation.c;
                gameState.crossword[actualRow][5] = '=';
                gameState.crossword[actualRow][6] = equation.result;
            }
            
            // Теперь генерируем вертикальные уравнения, используя числа из пересечений
            for (let col = 0; col < 3; col++) {
                const actualCol = col * 2;
                
                // Берем числа из пересечений с горизонтальными уравнениями
                const a = gameState.crossword[0][actualCol]; // из строки 0
                const b = gameState.crossword[2][actualCol]; // из строки 2
                const c = gameState.crossword[4][actualCol]; // из строки 4
                
                // Случайно выбираем формат для вертикального уравнения
                const useMultFirst = Math.random() < 0.5; // true для a * b +- c, false для a +- b * c
                let op1, op2;
                
                if (useMultFirst) {
                    op1 = '*';
                    op2 = Math.random() < 0.5 ? '+' : '-';
                } else {
                    op1 = Math.random() < 0.5 ? '+' : '-';
                    op2 = '*';
                }
                
                // Вычисляем результат
                let result;
                if (op1 === '+' && op2 === '*') {
                    result = a + (b * c);
                } else if (op1 === '-' && op2 === '*') {
                    result = a - (b * c);
                } else if (op1 === '*' && op2 === '+') {
                    result = (a * b) + c;
                } else if (op1 === '*' && op2 === '-') {
                    result = (a * b) - c;
                } else if (op1 === '+' && op2 === '+') {
                    result = a + b + c;
                } else if (op1 === '-' && op2 === '-') {
                    result = a - b - c;
                } else if (op1 === '+' && op2 === '-') {
                    result = a + b - c;
                } else if (op1 === '-' && op2 === '+') {
                    result = a - b + c;
                } else if (op1 === '*' && op2 === '*') {
                    result = a * b * c;
                }
                
                // Если результат отрицательный, пробуем другие комбинации знаков
                if (result <= 0) {
                    // Пробуем разные комбинации для положительного результата
                    const combinations = [
                        {op1: '+', op2: '*', calc: () => a + (b * c)},
                        {op1: '*', op2: '+', calc: () => (a * b) + c},
                        {op1: '+', op2: '+', calc: () => a + b + c},
                        {op1: '*', op2: '*', calc: () => a * b * c}
                    ];
                    
                    let foundValid = false;
                    for (let combo of combinations) {
                        result = combo.calc();
                        if (result > 0) {
                            op1 = combo.op1;
                            op2 = combo.op2;
                            foundValid = true;
                            break;
                        }
                    }
                    
                    // Если ничего не подошло, используем безопасную комбинацию
                    if (!foundValid) {
                        op1 = '+';
                        op2 = '*';
                        result = a + (b * c);
                    }
                }
                
                // Размещаем знаки
                gameState.crossword[1][actualCol] = op1;
                gameState.crossword[3][actualCol] = op2;
                
                // Размещаем результат
                gameState.crossword[5][actualCol] = '=';
                gameState.crossword[6][actualCol] = result;
                
                console.log(`Вертикальное уравнение столбец ${actualCol}: ${a} ${op1} ${b} ${op2} ${c} = ${result}`);
            }
            
            // Заполняем технические столбцы и строки
            fillTechnicalCells();
        }

        // Заполнение технических клеток
        function fillTechnicalCells() {
            // Очищаем только технические клетки (строки и столбцы 1, 3, 5)
            // НЕ трогаем основные уравнения (строки 0, 2, 4 и столбцы 0, 2, 4)
            for (let row = 1; row < 6; row += 2) { // строки 1, 3, 5
                for (let col = 0; col < 7; col++) {
                    // Очищаем только если это НЕ основные столбцы (0, 2, 4)
                    if (!(col === 0 || col === 2 || col === 4)) {
                        gameState.crossword[row][col] = '';
                    }
                }
            }
            
            for (let col = 1; col < 6; col += 2) { // столбцы 1, 3, 5
                for (let row = 0; row < 7; row++) {
                    // Очищаем только если это НЕ основные строки (0, 2, 4)
                    if (!(row === 0 || row === 2 || row === 4)) {
                        gameState.crossword[row][col] = '';
                    }
                }
            }
            
            // Оставляем знаки равно только в строке 5 для столбцов 0, 2, 4
            for (let col = 0; col < 6; col += 2) { // столбцы 0, 2, 4
                gameState.crossword[5][col] = '=';
            }
            
            
            // Копируем в решение
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    gameState.solution[row][col] = gameState.crossword[row][col];
                }
            }
            
            // Собираем ВСЕ числа из основных уравнений (включая повторения, НЕ ответы)
            gameState.usedNumbers = [];
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const value = gameState.crossword[row][col];
                    // Добавляем только числа из основных уравнений (строки 0, 2, 4 и столбцы 0, 2, 4)
                    // НЕ добавляем ответы (строка 6 и столбец 6)
                    if (typeof value === 'number' && 
                        (row === 0 || row === 2 || row === 4 || col === 0 || col === 2 || col === 4) &&
                        !(row === 6 || col === 6)) {
                        gameState.usedNumbers.push(value);
                    }
                }
            }
            
            // Создаем доступные числа (включая повторения)
            gameState.availableNumbers = [...gameState.usedNumbers];
            
            // Отладочная информация
            console.log('=== ОТЛАДКА КРОССВОРДА ===');
            console.log('Полная сетка после генерации:');
            for (let row = 0; row < 7; row++) {
                let rowStr = '';
                for (let col = 0; col < 7; col++) {
                    const value = gameState.crossword[row][col];
                    rowStr += (value === '' ? '[]' : value) + ' ';
                }
                console.log(`Строка ${row}: ${rowStr}`);
            }
            console.log('Горизонтальные уравнения:');
            for (let row = 0; row < 3; row++) {
                const actualRow = row * 2;
                const equation = gameState.crossword[actualRow];
                console.log(`Строка ${actualRow}: ${equation[0]} ${equation[1]} ${equation[2]} ${equation[3]} ${equation[4]} ${equation[5]} ${equation[6]}`);
            }
            console.log('Вертикальные уравнения:');
            for (let col = 0; col < 3; col++) {
                const actualCol = col * 2;
                const colData = [];
                for (let row = 0; row < 7; row++) {
                    colData.push(gameState.crossword[row][actualCol]);
                }
                console.log(`Столбец ${actualCol}: ${colData[0]} ${colData[1]} ${colData[2]} ${colData[3]} ${colData[4]} ${colData[5]} ${colData[6]}`);
            }
            console.log('Используемые числа:', gameState.usedNumbers);
            console.log('========================');
            
            // Очищаем только числа в основных уравнениях (строки 0, 2, 4 и столбцы 0, 2, 4)
            // НЕ трогаем знаки операций и ответы
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const value = gameState.crossword[row][col];
                    // Очищаем числа только в основных уравнениях, но НЕ в ответах
                    if (typeof value === 'number' && 
                        (row === 0 || row === 2 || row === 4 || col === 0 || col === 2 || col === 4) &&
                        !(row === 6 || col === 6)) {
                        gameState.crossword[row][col] = '';
                    }
                }
            }
            
            // Очищаем знаки только в технических строках и столбцах (1, 3, 5)
            // НЕ трогаем знаки в основных уравнениях (строки 0, 2, 4 и столбцы 0, 2, 4)
            for (let row = 1; row < 6; row += 2) { // строки 1, 3, 5
                for (let col = 0; col < 7; col++) {
                    // Очищаем знаки только если это НЕ основные столбцы (0, 2, 4)
                    if (['+', '-', '*'].includes(gameState.crossword[row][col]) && 
                        !(col === 0 || col === 2 || col === 4)) {
                        gameState.crossword[row][col] = '';
                    }
                }
            }
            
            for (let col = 1; col < 6; col += 2) { // столбцы 1, 3, 5
                for (let row = 0; row < 7; row++) {
                    // Очищаем знаки только если это НЕ основные строки (0, 2, 4)
                    if (['+', '-', '*'].includes(gameState.crossword[row][col]) && 
                        !(row === 0 || row === 2 || row === 4)) {
                        gameState.crossword[row][col] = '';
                    }
                }
            }
        }

        // Генерация чисел для уравнения с заданными знаками
        function generateNumbersForEquation(op1, op2, addSubRange, multRange) {
            let a, b, c, result;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                // Генерируем числа в зависимости от позиции знаков
                if (op1 === '*' && op2 === '+') {
                    // Формат: a * b + c
                    a = getRandomNumber(multRange);
                    b = getRandomNumber(multRange);
                    c = getRandomNumber(addSubRange);
                } else if (op1 === '*' && op2 === '-') {
                    // Формат: a * b - c
                    a = getRandomNumber(multRange);
                    b = getRandomNumber(multRange);
                    c = getRandomNumber(addSubRange);
                } else if (op1 === '+' && op2 === '*') {
                    // Формат: a + b * c
                    a = getRandomNumber(addSubRange);
                    b = getRandomNumber(multRange);
                    c = getRandomNumber(multRange);
                } else if (op1 === '-' && op2 === '*') {
                    // Формат: a - b * c
                    a = getRandomNumber(addSubRange);
                    b = getRandomNumber(multRange);
                    c = getRandomNumber(multRange);
                } else {
                    // Остальные случаи (+, +), (-, -), (+, -), (-, +), (*, *)
                    a = getRandomNumber(addSubRange);
                    b = getRandomNumber(addSubRange);
                    c = getRandomNumber(addSubRange);
                }
                
                // Вычисляем результат по правилам математики (сначала умножение, потом сложение/вычитание)
                if (op1 === '+' && op2 === '*') {
                    result = a + (b * c);
                } else if (op1 === '-' && op2 === '*') {
                    result = a - (b * c);
                } else if (op1 === '*' && op2 === '+') {
                    result = (a * b) + c;
                } else if (op1 === '*' && op2 === '-') {
                    result = (a * b) - c;
                } else if (op1 === '+' && op2 === '+') {
                    result = a + b + c;
                } else if (op1 === '-' && op2 === '-') {
                    result = a - b - c;
                } else if (op1 === '+' && op2 === '-') {
                    result = a + b - c;
                } else if (op1 === '-' && op2 === '+') {
                    result = a - b + c;
                } else if (op1 === '*' && op2 === '*') {
                    result = a * b * c;
                }
                
                attempts++;
            } while (result <= 0 && attempts < maxAttempts);
            
            // Если не удалось найти положительный результат, используем безопасные значения
            if (result <= 0) {
                if (op1 === '*' && op2 === '+') {
                    a = multRange.min;
                    b = multRange.min;
                    c = addSubRange.min;
                    result = (a * b) + c;
                } else if (op1 === '*' && op2 === '-') {
                    a = multRange.min;
                    b = multRange.min;
                    c = addSubRange.min;
                    result = Math.max(1, (a * b) - c);
                } else if (op1 === '+' && op2 === '*') {
                    a = addSubRange.min;
                    b = multRange.min;
                    c = multRange.min;
                    result = a + (b * c);
                } else if (op1 === '-' && op2 === '*') {
                    a = addSubRange.max;
                    b = multRange.min;
                    c = multRange.min;
                    result = Math.max(1, a - (b * c));
                } else {
                    a = addSubRange.min;
                    b = addSubRange.min;
                    c = addSubRange.min;
                    result = Math.max(1, a + b + c);
                }
            }
            
            console.log(`Сгенерировано уравнение: ${a} ${op1} ${b} ${op2} ${c} = ${result}`);
            return {a, b, c, op1, op2, result};
        }

        // Получение случайного числа из диапазона
        function getRandomNumber(range) {
            return Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
        }

        // Создание игрового поля
        function createGameField() {
            // Очищаем поля
            numberPool.innerHTML = '';
            crosswordContainer.innerHTML = '';
            answerCrossword.innerHTML = '';
            
            // Создаем пул чисел
            gameState.availableNumbers.forEach((num, index) => {
                const numberItem = document.createElement('div');
                numberItem.className = 'number-item';
                numberItem.textContent = num;
                numberItem.draggable = true;
                numberItem.dataset.value = num;
                numberItem.dataset.index = index;
                
                numberItem.addEventListener('dragstart', handleDragStart);
                numberItem.addEventListener('dragend', handleDragEnd);
                
                numberPool.appendChild(numberItem);
            });
            
            // Создаем кроссворд
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'crossword-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    const value = gameState.crossword[row][col];
                    
                     if (value === '') {
                         // Проверяем, активная ли это клетка (в основных уравнениях)
                         if (row === 0 || row === 2 || row === 4 || col === 0 || col === 2 || col === 4) {
                             // Активная клетка для числа
                             cell.className += ' empty';
                             cell.addEventListener('dragover', handleDragOver);
                             cell.addEventListener('dragleave', handleDragLeave);
                             cell.addEventListener('drop', handleDrop);
                             cell.addEventListener('click', handleCellClick);
                         } else {
                             // Неактивная клетка
                             cell.className += ' inactive';
                         }
                     } else if (typeof value === 'number') {
                         // Проверяем, является ли это ответом (строка 6 или столбец 6)
                         if (row === 6 || col === 6) {
                             cell.textContent = value;
                             cell.classList.add('answer');
                         } else {
                             // Клетка с числом (в основных уравнениях)
                             cell.textContent = value;
                             cell.classList.add('locked');
                         }
                     } else if (['+', '-', '*'].includes(value)) {
                         // Клетка с оператором
                         cell.className += ' operator';
                         cell.textContent = value;
                         cell.classList.add('locked');
                     } else if (value === '=') {
                         // Клетка с равно
                         cell.className += ' equals';
                         cell.textContent = value;
                         cell.classList.add('locked');
                     }
                    
                    crosswordContainer.appendChild(cell);
                }
            }
            
            // Отладочная информация о созданном кроссворде
            console.log('=== СОЗДАННЫЙ КРОССВОРД ===');
            for (let row = 0; row < 7; row++) {
                let rowStr = '';
                for (let col = 0; col < 7; col++) {
                    const value = gameState.crossword[row][col];
                    rowStr += (value === '' ? '[]' : value) + ' ';
                }
                console.log(`Строка ${row}: ${rowStr}`);
            }
            console.log('========================');
        }

        // Обработчики drag and drop
        let draggedElement = null;

         function handleDragStart(e) {
             // Проверяем, не неактивно ли число
             if (e.target.classList.contains('inactive')) {
                 e.preventDefault();
                 return;
             }
             
             draggedElement = e.target;
             e.target.classList.add('dragging');
             e.dataTransfer.effectAllowed = 'copy';
         }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (!draggedElement) return;
            
            const row = parseInt(e.target.dataset.row);
            const col = parseInt(e.target.dataset.col);
            const value = parseInt(draggedElement.dataset.value);
            
            // Проверяем, не заблокирована ли клетка
            if (e.target.classList.contains('locked')) {
                return;
            }
            
            // Размещаем число
            placeNumber(row, col, value);
        }

         function handleCellClick(e) {
             const row = parseInt(e.target.dataset.row);
             const col = parseInt(e.target.dataset.col);
             
             // Если клетка заблокирована, ничего не делаем
             if (e.target.classList.contains('locked')) {
                 return;
             }
             
             // Если в клетке есть число, удаляем его
             if (e.target.textContent) {
                 const value = parseInt(e.target.textContent);
                 e.target.textContent = '';
                 gameState.crossword[row][col] = '';
                 
                 // Возвращаем число в пул (делаем активным)
                 const numberItems = document.querySelectorAll('.number-item');
                 for (let item of numberItems) {
                     if (parseInt(item.dataset.value) === value && item.classList.contains('inactive')) {
                         item.classList.remove('inactive');
                         item.draggable = true;
                         break;
                     }
                 }
                 
                 checkEquations();
             }
         }

         function placeNumber(row, col, value) {
             const cell = crosswordContainer.children[row * 7 + col];
             cell.textContent = value;
             gameState.crossword[row][col] = value;
             
             // Делаем число неактивным в пуле
             if (draggedElement) {
                 draggedElement.classList.add('inactive');
                 draggedElement.draggable = false;
             }
             
             // Отладочная информация
             console.log(`Размещено число ${value} в позицию [${row}][${col}]`);
             console.log('Текущее состояние кроссворда:');
             for (let r = 0; r < 7; r++) {
                 console.log(`Строка ${r}:`, gameState.crossword[r]);
             }
             
             checkEquations();
         }

        // Проверка уравнений
        function checkEquations() {
            // Сбрасываем все ошибки
            document.querySelectorAll('.crossword-cell').forEach(cell => {
                cell.classList.remove('error');
            });
            
            let hasErrors = false;
            
            // Проверяем горизонтальные уравнения (строки)
            for (let row = 0; row < 3; row++) {
                const equation = getRowEquation(row);
                if (equation && !isValidEquation(equation)) {
                    markRowError(row);
                    hasErrors = true;
                }
            }
            
            // Проверяем вертикальные уравнения (столбцы)
            for (let col = 0; col < 3; col++) {
                const equation = getColEquation(col);
                if (equation && !isValidEquation(equation)) {
                    markColError(col);
                    hasErrors = true;
                }
            }
            
            return !hasErrors;
        }

        function getRowEquation(row) {
            const a = gameState.crossword[row][0];
            const op1 = gameState.crossword[row][1];
            const b = gameState.crossword[row][2];
            const op2 = gameState.crossword[row][3];
            const c = gameState.crossword[row][4];
            const result = gameState.crossword[row][6];
            
            if (typeof a === 'number' && typeof b === 'number' && typeof c === 'number' && typeof result === 'number') {
                return {a, b, c, op1, op2, result};
            }
            return null;
        }

        function getColEquation(col) {
            const a = gameState.crossword[0][col];
            const op1 = gameState.crossword[1][col];
            const b = gameState.crossword[2][col];
            const op2 = gameState.crossword[3][col];
            const c = gameState.crossword[4][col];
            const result = gameState.crossword[6][col];
            
            if (typeof a === 'number' && typeof b === 'number' && typeof c === 'number' && typeof result === 'number') {
                return {a, b, c, op1, op2, result};
            }
            return null;
        }

        function isValidEquation(equation) {
            const {a, b, c, op1, op2, result} = equation;
            
            let calculated;
            if (op1 === '+' && op2 === '*') {
                calculated = a + (b * c);
            } else if (op1 === '-' && op2 === '*') {
                calculated = a - (b * c);
            } else if (op1 === '+' && op2 === '+') {
                calculated = a + b + c;
            } else if (op1 === '-' && op2 === '-') {
                calculated = a - b - c;
            } else if (op1 === '+' && op2 === '-') {
                calculated = a + b - c;
            } else if (op1 === '-' && op2 === '+') {
                calculated = a - b + c;
            } else if (op1 === '*' && op2 === '+') {
                calculated = (a * b) + c;
            } else if (op1 === '*' && op2 === '-') {
                calculated = (a * b) - c;
            } else if (op1 === '*' && op2 === '*') {
                calculated = a * b * c;
            } else {
                return false;
            }
            
            return calculated === result;
        }

        function markRowError(row) {
            for (let col = 0; col < 7; col++) {
                const cell = crosswordContainer.children[row * 7 + col];
                if (!cell.classList.contains('locked')) {
                    cell.classList.add('error');
                }
            }
        }

        function markColError(col) {
            for (let row = 0; row < 7; row++) {
                const cell = crosswordContainer.children[row * 7 + col];
                if (!cell.classList.contains('locked')) {
                    cell.classList.add('error');
                }
            }
        }

        // Проверка победы
        function checkWin() {
            if (!gameState.isGameActive) return false;
            
            // Проверяем, что все клетки заполнены
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = crosswordContainer.children[row * 7 + col];
                    if (!cell.classList.contains('locked') && !cell.textContent) {
                        return false;
                    }
                }
            }
            
            // Проверяем отсутствие ошибок
            return checkEquations();
        }

         // Показать ответ
         function showAnswer() {
             // Создаем ответный кроссворд
             answerCrossword.innerHTML = '';
             answerCrossword.style.gridTemplateColumns = 'repeat(7, 60px)';
             answerCrossword.style.gridTemplateRows = 'repeat(7, 60px)';
             answerCrossword.style.gap = '2px';
             answerCrossword.style.background = 'rgba(255,255,255,0.18)';
             answerCrossword.style.borderRadius = '12px';
             answerCrossword.style.boxShadow = '0 4px 16px 0 rgba(31,38,135,0.15)';
             answerCrossword.style.border = '1px solid rgba(255,255,255,0.15)';
             answerCrossword.style.padding = '10px';
             
             for (let row = 0; row < 7; row++) {
                 for (let col = 0; col < 7; col++) {
                     const cell = document.createElement('div');
                     cell.className = 'crossword-cell';
                     cell.style.width = '60px';
                     cell.style.height = '60px';
                     
                     const value = gameState.solution[row][col];
                     
                     if (['+', '-', '*'].includes(value)) {
                         cell.className += ' operator';
                         cell.textContent = value;
                     } else if (value === '=') {
                         cell.className += ' equals';
                         cell.textContent = value;
                     } else if (typeof value === 'number' && (row === 6 || col === 6)) {
                         // Ответы в кружочках
                         cell.className += ' answer';
                         cell.textContent = value;
                     } else {
                         cell.textContent = value;
                     }
                     
                     answerCrossword.appendChild(cell);
                 }
             }
             
             answerContainer.classList.add('visible');
             gameState.isGameActive = false;
             gameMessage.innerHTML = '<div class="victory-message">Ответ показан!</div>';
         }

        // Слушатели событий
        newGameBtn.addEventListener('click', initGame);
        checkBtn.addEventListener('click', () => {
            if (checkWin()) {
                gameState.isGameActive = false;
                gameMessage.innerHTML = '<div class="victory-message">Поздравляем! Вы решили кроссворд!</div>';
            } else {
                gameMessage.textContent = 'Есть ошибки! Исправьте их и попробуйте снова.';
            }
        });
        showAnswerBtn.addEventListener('click', showAnswer);

        // Обработчик для перетаскивания вне поля
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            // Если перетащили вне поля, ничего не делаем
        });
    </script>
</body>
</html>
