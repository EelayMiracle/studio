<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Тренажер на 4 действия</title>
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 600px;
    margin: 0 auto;
    padding: 15px;
    text-align: center;
}

/* Фоновое изображение с затемнением */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.1)),
        url('img/f1.jpg') center/cover no-repeat;
    z-index: -2;
}

/* Поверх фонового изображения добавим ваш градиент с прозрачностью */
body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(110, 142, 251, 0.8), rgba(167, 119, 227, 0.3));
    z-index: -1;
}

.game-area {
    width: 100%;
    background-color: rgba(222, 158, 255, 0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
    position: relative;
    overflow: hidden;
}

h2, h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    font-size: clamp(1.3rem, 4vw, 1.8rem);
}

.operations-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.operation-btn {
    padding: 12px 18px;
    font-size: clamp(16px, 4vw, 18px);
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    min-width: 50px;
    font-weight: bold;
    flex: 1;
    max-width: 70px;
}

.operation-btn.active {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border-color: #4CAF50;
}

.operation-btn:not(.active) {
    background: rgba(128, 128, 128, 0.3);
    color: #666;
}

.settings-row {
    margin: 15px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.settings-row label {
    font-weight: bold;
    color: #333;
    text-align: center;
    width: 100%;
    margin-bottom: 5px;
}

.settings-row select, .settings-row input {
    padding: 10px 12px;
    font-size: 16px;
    border: 2px solid #000000;
    border-radius: 50px;
    background-color: rgba(255, 255, 255, 0.9);
    transition: all 0.3s;
    outline: none;
    text-align: center;
    width: 100%;
    max-width: 200px;
}

.settings-row input {
    max-width: 80px;
}

.settings-row label input[type="checkbox"] {
    margin-right: 8px;
    transform: scale(1.2);
}

/* Стили для таймера и сообщений */
.timer-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 15px 0;
    padding: 10px;
    height: 80px;
    position: relative;
}

.timer {
    font-size: clamp(1.2rem, 4vw, 1.5rem);
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #ff9800, #ff5722);
    padding: 12px 20px;
    border-radius: 25px;
    min-width: 90px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    position: relative;
    z-index: 2;
}

.time-feedback {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(1rem, 3vw, 1.2rem);
    font-weight: bold;
    padding: 5px 10px;
    margin-top: -5px;
    height: 30px;
    line-height: 30px;
    animation: fadeOut 1s ease-in-out forwards;
    visibility: hidden;
    z-index: 1;
}

.time-feedback:not(.hidden) {
    visibility: visible;
}

.time-bonus {
    color: #4CAF50;
}

.time-penalty {
    color: #f44336;
}

@keyframes fadeOut {
    0% { opacity: 1; }
    70% { opacity: 1; }
    100% { opacity: 0; }
}

.time-over-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(244, 67, 54, 0.95);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border: 3px solid #d32f2f;
    max-width: 80%;
}

.time-over-message h2 {
    color: white;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

.time-over-message p {
    margin: 10px 0;
    font-size: 1.1rem;
}

.time-over-message button {
    margin-top: 15px;
    padding: 10px 20px;
    background: white;
    color: #f44336;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.time-over-message button:hover {
    background: #f8f9fa;
    transform: scale(1.05);
}

#startBtn, #homeBtn {
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 50px;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    font-weight: bold;
    min-width: 150px;
    margin: 10px 5px;
    width: 100%;
    max-width: 250px;
}

#startBtn:hover, #homeBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

#quiz .question {
    font-size: clamp(1.5rem, 6vw, 2rem);
    margin: 30px 0 20px 0;
    text-align: center;
    background: linear-gradient(135deg, #3498db, #2980b9);
    padding: 20px 15px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border: 2px solid #1a5276;
    font-weight: bold;
    color: white;
    word-wrap: break-word;
    line-height: 1.4;
}

.answers {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
}

.answers button {
    width: calc(50% - 10px);
    min-width: 120px;
    margin: 5px 0;
    padding: 15px 10px;
    font-size: clamp(18px, 4vw, 20px);
    background: white;
    border: 2px solid #1a5276;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.answers button:hover {
    background: #f8f9fa;
    transform: scale(1.05);
    border-color: #2980b9;
}

.correct { 
    background: linear-gradient(135deg, #a0e7a0, #80c080) !important; 
    color: white;
    border-color: #4CAF50 !important;
}
.wrong { 
    background: linear-gradient(135deg, #f08080, #d06060) !important; 
    color: white;
    border-color: #e74c3c !important;
}

.progress-bar-container {
    margin: 15px 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.progress-bar {
    width: 100%;
    height: 25px;
    background: #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
    height: 100%;
    border-radius: 12px;
    transition: width 0.3s ease;
    position: relative;
}

.progress-correct {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    float: left;
}

.progress-incorrect {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    float: left;
}

.progress-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 12px;
    font-weight: bold;
    color: #333;
}

.stats { 
    display: flex; 
    flex-direction: column;
    gap: 10px;
    margin-top: 10px; 
    font-weight: bold;
    padding: 15px;
    border-radius: 15px;
    font-size: clamp(14px, 3vw, 16px);
}

.hidden { display: none; }

.range-group {
    margin-bottom: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    width: 100%;
}

.range-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    color: #333;
    font-size: clamp(14px, 3vw, 16px);
}

.range-inputs {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.range-inputs input {
    width: 70px;
    max-width: 80px;
    border-radius: 50px !important;
    border: 2px solid #000000 !important;
}

.range-inputs > div {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    width: 100%;
}

.range-inputs span {
    font-weight: bold;
    margin: 0 5px;
}

/* Специальные стили для настроек блитц режима */
.blitz-settings-container {
    display: flex;
    gap: 20px;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
}

.blitz-labels-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 1;
    max-width: 300px;
}

.blitz-label {
    font-weight: bold;
    color: #333;
    text-align: right;
    padding: 8px 0;
    height: 40px;
    line-height: 24px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.blitz-inputs-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 0 0 auto;
}

.blitz-inputs-container input {
    width: 80px;
    padding: 8px 10px;
    font-size: 16px;
    border: 2px solid #000000;
    border-radius: 50px;
    background-color: rgba(255, 255, 255, 0.9);
    text-align: center;
    height: 40px;
    box-sizing: border-box;
}

/* Медиа-запросы для разных размеров экранов */
@media (min-width: 768px) {
    body {
        padding: 20px;
    }
    
    .game-area {
        padding: 25px;
    }
    
    .settings-row {
        flex-direction: row;
        justify-content: center;
    }
    
    .settings-row label {
        min-width: 150px;
        text-align: right;
        margin-bottom: 0;
        width: auto;
    }
    
    .settings-row select, .settings-row input {
        width: auto;
    }
    
    .stats {
        flex-direction: row;
        justify-content: space-around;
    }
    
    .answers button {
        width: 45%;
    }
}

@media (max-width: 480px) {
    .game-area {
        padding: 15px;
    }
    
    .operations-buttons {
        gap: 8px;
    }
    
    .operation-btn {
        padding: 10px 12px;
        min-width: 45px;
        font-size: 16px;
    }
    
    .settings-row select, .settings-row input {
        padding: 8px 10px;
        font-size: 14px;
    }
    
    #quiz .question {
        padding: 15px 10px;
        font-size: 1.3rem;
    }
    
    .answers button {
        width: 100%;
        max-width: 200px;
        padding: 12px 8px;
        font-size: 18px;
    }
    
    .range-inputs {
        flex-direction: column;
        gap: 5px;
    }
    
    .range-inputs > div {
        display: flex;
        align-items: center;
        gap: 5px;
    }
}

@media (max-width: 360px) {
    body {
        padding: 10px;
    }
    
    .game-area {
        padding: 10px;
    }
    
    .operation-btn {
        padding: 8px 10px;
        min-width: 40px;
        font-size: 14px;
    }
    
    #quiz .question {
        font-size: 1.2rem;
        padding: 12px 8px;
    }
    
    .answers button {
        padding: 10px 6px;
        font-size: 16px;
    }
}

/* Для очень высоких экранов */
@media (min-height: 800px) and (max-width: 768px) {
    .game-area {
        margin-top: 20px;
        margin-bottom: 20px;
    }
}

/* Портретная ориентация */
@media (orientation: portrait) {
    .answers {
        gap: 8px;
    }
    
    .answers button {
        width: calc(50% - 8px);
    }
}

/* Ландшафтная ориентация на мобильных */
@media (orientation: landscape) and (max-height: 500px) {
    .game-area {
        padding: 15px;
    }
    
    #quiz .question {
        margin: 10px 0;
        padding: 12px;
        font-size: 1.3rem;
    }
    
    .answers {
        margin: 10px 0;
    }
    
    .answers button {
        padding: 8px 6px;
        font-size: 16px;
    }
    
    .stats {
        margin-top: 10px;
        padding: 10px;
    }
}
	.back-button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-size: 24px;
            border-radius: 50%;
            text-decoration: none;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .back-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
</style>
</head>
<body>
<div class="game-area">

<div id="settings">
<h2>Настройки тренажера <a href="index.html" class="back-button">←</a> </h1></h2>

<div class="operations-buttons">
    <button class="operation-btn active" data-op="+">+</button>
    <button class="operation-btn active" data-op="-">-</button>
    <button class="operation-btn active" data-op="*">×</button>
    <button class="operation-btn active" data-op="/">÷</button>
</div>

<div class="settings-row">
    <label>Режим:</label>
    <select id="mode">
        <option value="noneq">Без уравнений</option>
        <option value="eq">С уравнениями</option>
        <option value="mixed">Смешанный</option>
    </select>
</div>

<!-- Блитц режим -->
<div class="settings-row">
    <label>
        <input type="checkbox" id="blitzMode"> Блитц - на время
    </label>
</div>

<div id="blitzSettings" class="hidden range-group">
    <h3>Настройки блитц режима</h3>
    
    <div class="blitz-settings-container">
        <div class="blitz-labels-container">
            <div class="blitz-label">Общее время (сек)</div>
            <div class="blitz-label">Отнимать за неправильный (сек)</div>
            <div class="blitz-label">Прибавлять за решенный (сек)</div>
        </div>
        
        <div class="blitz-inputs-container">
            <input type="number" id="totalTime" value="60" min="10" max="600">
            <input type="number" id="penaltyTime" value="0" min="0" max="10">
            <input type="number" id="bonusTime" value="5" min="0" max="10">
        </div>
    </div>
</div>

<h3>Диапазоны для операций</h3>

<div class="range-group">
    <label>Сложение: a + b</label>
    <div class="range-inputs">
        <div>
            a: <input type="number" id="addAMin" value="5"> - <input type="number" id="addAMax" value="15">
        </div>
        <div>
            b: <input type="number" id="addBMin" value="5"> - <input type="number" id="addBMax" value="15">
        </div>
    </div>
</div>

<div class="range-group">
    <label>Вычитание: a - b</label>
    <div class="range-inputs">
        <div>
            b: <input type="number" id="subBMin" value="5"> - <input type="number" id="subBMax" value="15">
        </div>
        <div>
            c: <input type="number" id="subCMin" value="5"> - <input type="number" id="subCMax" value="15">
        </div>
    </div>
</div>

<div class="range-group">
    <label>Умножение: a × b</label>
    <div class="range-inputs">
        <div>
            a: <input type="number" id="mulAMin" value="2"> - <input type="number" id="mulAMax" value="9">
        </div>
        <div>
            b: <input type="number" id="mulBMin" value="2"> - <input type="number" id="mulBMax" value="9">
        </div>
    </div>
</div>

<div class="range-group">
    <label>Деление: a ÷ b</label>
    <div class="range-inputs">
        <div>
            b: <input type="number" id="divBMin" value="2"> - <input type="number" id="divBMax" value="9">
        </div>
        <div>
            c: <input type="number" id="divCMin" value="2"> - <input type="number" id="divCMax" value="9">
        </div>
    </div>
</div>

<button id="startBtn">Начать тренировку</button>
</div>

<div id="quiz" class="hidden">
<div id="timerContainer" class="timer-container hidden">
    <div class="timer" id="timer">00:00</div>
    <div id="timeFeedback" class="hidden"></div>
</div>
<div class="question" id="question"></div>
<div class="answers" id="answers"></div>
<div class="progress-bar-container">
    <div class="progress-bar">
        <div class="progress-fill progress-correct" id="progressCorrect" style="width: 0%"></div>
        <div class="progress-fill progress-incorrect" id="progressIncorrect" style="width: 0%"></div>
    </div>
    <div class="progress-labels">
        <span id="progressCorrectLabel">0% правильных</span>
        <span id="progressIncorrectLabel">0% неправильных</span>
    </div>
    <div class="score-display" style="text-align: center; margin-top: 10px; font-weight: bold; font-size: 18px; color: #333;">
        Очки: <span id="totalScore">0</span>
    </div>
</div>
<div class="stats">
    <span>Правильно с первого раза: <span id="correctFirst">0</span></span>
    <span>Неправильно: <span id="incorrect">0</span></span>
</div>
<br>
<button id="homeBtn">Вернуться к настройкам</button>
</div>

</div>

<script>
// Глобальные переменные
let settings = {};
let currentAnswer = 0;
let firstTry = true;
let correctFirst = 0;
let incorrect = 0;
let lastMode = null;
let modeCounter = 0;
let totalScore = 0; // Общий счет очков
let questionStartTime = 0; // Время начала текущего вопроса

// Переменные для блитц режима
let blitzMode = false;
let timeLeft = 0;
let timerInterval = null;
let startTime = 0;
let totalElapsedTime = 0;

// Инициализация кнопок операций
document.querySelectorAll('.operation-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        this.classList.toggle('active');
    });
});

// Обработчик для галочки блитц режима
document.getElementById('blitzMode').addEventListener('change', function() {
    const blitzSettings = document.getElementById('blitzSettings');
    if (this.checked) {
        blitzSettings.classList.remove('hidden');
    } else {
        blitzSettings.classList.add('hidden');
    }
});

document.getElementById("startBtn").onclick = () => {
    const activeOperations = Array.from(document.querySelectorAll('.operation-btn.active'))
        .map(btn => btn.getAttribute('data-op'));
    
    if (activeOperations.length === 0) {
        alert('Выберите хотя бы одну операцию!');
        return;
    }

    settings = {
        operations: activeOperations,
        mode: document.getElementById('mode').value,
        add: {
            aMin: parseInt(document.getElementById('addAMin').value), 
            aMax: parseInt(document.getElementById('addAMax').value),
            bMin: parseInt(document.getElementById('addBMin').value), 
            bMax: parseInt(document.getElementById('addBMax').value)
        },
        sub: {
            bMin: parseInt(document.getElementById('subBMin').value), 
            bMax: parseInt(document.getElementById('subBMax').value),
            cMin: parseInt(document.getElementById('subCMin').value), 
            cMax: parseInt(document.getElementById('subCMax').value)
        },
        mul: {
            aMin: parseInt(document.getElementById('mulAMin').value), 
            aMax: parseInt(document.getElementById('mulAMax').value),
            bMin: parseInt(document.getElementById('mulBMin').value), 
            bMax: parseInt(document.getElementById('mulBMax').value)
        },
        div: {
            bMin: parseInt(document.getElementById('divBMin').value), 
            bMax: parseInt(document.getElementById('divBMax').value),
            cMin: parseInt(document.getElementById('divCMin').value), 
            cMax: parseInt(document.getElementById('divCMax').value)
        }
    };

    // Проверяем включен ли блитц режим
    blitzMode = document.getElementById('blitzMode').checked;
    
    document.getElementById('settings').classList.add('hidden');
    document.getElementById('quiz').classList.remove('hidden');
    lastMode = null;
    modeCounter = 0;
    
    // Инициализация блитц режима
    if (blitzMode) {
        timeLeft = parseInt(document.getElementById('totalTime').value);
        startTime = Date.now();
        totalElapsedTime = 0;
        document.getElementById('timerContainer').classList.remove('hidden');
        startTimer();
    } else {
        document.getElementById('timerContainer').classList.add('hidden');
    }
    
    nextQuestion();
};

document.getElementById("homeBtn").onclick = () => {
    document.getElementById('settings').classList.remove('hidden');
    document.getElementById('quiz').classList.add('hidden');
    correctFirst = 0; 
    incorrect = 0;
    totalScore = 0; // Обнуляем счет очков
    document.getElementById('correctFirst').textContent = correctFirst;
    document.getElementById('incorrect').textContent = incorrect;
    updateScoreDisplay(); // Обновляем отображение очков
    
    // Обнуляем прогресс-бар
    document.getElementById('progressCorrect').style.width = '0%';
    document.getElementById('progressIncorrect').style.width = '0%';
    document.getElementById('progressCorrectLabel').textContent = '0% правильных';
    document.getElementById('progressIncorrectLabel').textContent = '0% неправильных';
    
    // Останавливаем таймер если он запущен
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
};

// Функции для работы с таймером
function startTimer() {
    updateTimerDisplay();
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            showTimeOverMessage();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function showTimeBonus(bonus) {
    if (bonus > 0) {
        const feedback = document.getElementById('timeFeedback');
        feedback.textContent = `+${bonus} сек`;
        feedback.className = 'time-feedback time-bonus';
        feedback.classList.remove('hidden');
        
        setTimeout(() => {
            feedback.classList.add('hidden');
        }, 1000);
    }
}

function showTimePenalty(penalty) {
    if (penalty > 0) {
        const feedback = document.getElementById('timeFeedback');
        feedback.textContent = `-${penalty} сек`;
        feedback.className = 'time-feedback time-penalty';
        feedback.classList.remove('hidden');
        
        setTimeout(() => {
            feedback.classList.add('hidden');
        }, 1000);
    }
}

function showTimeOverMessage() {
    const elapsedMinutes = Math.floor(totalElapsedTime / 60);
    const elapsedSeconds = totalElapsedTime % 60;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'time-over-message';
    messageDiv.innerHTML = `
        <h2>Время закончилось!</h2>
        <p>Всего прошло времени: ${elapsedMinutes} минут ${elapsedSeconds} секунд</p>
        <p>Правильных ответов: ${correctFirst}</p>
        <p>Неправильных ответов: ${incorrect}</p>
        <p style="font-size: 1.3rem; font-weight: bold; color: #FFD700;">Итоговый счет: ${totalScore} очков</p>
        <button onclick="this.parentElement.remove()">OK</button>
    `;
    document.body.appendChild(messageDiv);
}

function getRandomInt(min, max) { 
    return Math.floor(Math.random()*(max-min+1))+min; 
}

function shuffle(array) { 
    return array.sort(() => Math.random() - 0.5); 
}

function getOperationSymbol(op) {
    switch(op) {
        case '+': return '+';
        case '-': return '-';
        case '*': return '×';
        case '/': return '÷';
        default: return op;
    }
}

function generateQuestion() {
    let op = settings.operations[Math.floor(Math.random()*settings.operations.length)];
    let displayOp = getOperationSymbol(op);
    let a, b, c, questionStr;
    let unknownAtLeft = false;

    if(settings.mode === 'mixed') {
        if (modeCounter >= 2) {
            unknownAtLeft = !lastMode;
            lastMode = unknownAtLeft;
            modeCounter = 1;
        } else {
            unknownAtLeft = Math.random() < 0.5;
            if (unknownAtLeft === lastMode) {
                modeCounter++;
            } else {
                lastMode = unknownAtLeft;
                modeCounter = 1;
            }
        }
    } else if(settings.mode === 'eq') {
        unknownAtLeft = Math.random() < 0.5;
    }

    switch(op){
        case '+':
            a = getRandomInt(settings.add.aMin, settings.add.aMax);
            b = getRandomInt(settings.add.bMin, settings.add.bMax);
            c = a + b;
            break;
        case '-':
            b = getRandomInt(settings.sub.bMin, settings.sub.bMax);
            c = getRandomInt(settings.sub.cMin, settings.sub.cMax);
            a = b + c;
            break;
        case '*':
            a = getRandomInt(settings.mul.aMin, settings.mul.aMax);
            b = getRandomInt(settings.mul.bMin, settings.mul.bMax);
            c = a * b;
            break;
        case '/':
            b = getRandomInt(settings.div.bMin, settings.div.bMax);
            c = getRandomInt(settings.div.cMin, settings.div.cMax);
            a = b * c;
            break;
    }

    if(settings.mode==='noneq' || (settings.mode==='mixed' && !unknownAtLeft)){
        questionStr = `${a} ${displayOp} ${b} = ?`;
        currentAnswer = c;
    }else{
        if(Math.random()<0.5){
            questionStr = `? ${displayOp} ${b} = ${c}`;
            currentAnswer = a;
        }else{
            questionStr = `${a} ${displayOp} ? = ${c}`;
            currentAnswer = b;
        }
    }

    return questionStr;
}

function updateProgressBar() {
    const total = correctFirst + incorrect;
    if (total === 0) {
        document.getElementById('progressCorrect').style.width = '0%';
        document.getElementById('progressIncorrect').style.width = '0%';
        document.getElementById('progressCorrectLabel').textContent = '0% правильных';
        document.getElementById('progressIncorrectLabel').textContent = '0% неправильных';
        return;
    }

    const correctPercent = Math.round((correctFirst / total) * 100);
    const incorrectPercent = Math.round((incorrect / total) * 100);

    document.getElementById('progressCorrect').style.width = correctPercent + '%';
    document.getElementById('progressIncorrect').style.width = incorrectPercent + '%';
    document.getElementById('progressCorrectLabel').textContent = correctPercent + '% правильных';
    document.getElementById('progressIncorrectLabel').textContent = incorrectPercent + '% неправильных';
}

function generateWrongAnswers(correctAnswer) {
    const percentages = [25, 50, 75]; // Используем фиксированные проценты: 25%, 50%, 75%
    let wrongAnswers = [];
    
    // Гарантируем, что будет хотя бы один вариант больше и хотя бы один меньше правильного ответа
    const hasGreater = Math.random() < 0.5; // Случайно определяем, будет ли больше вариантов "больше" или "меньше"
    
    // Создаем 3 неправильных ответа
    for (let i = 0; i < 3; i++) {
        let wrongAnswer;
        let attempts = 0;
        const maxAttempts = 10;
        
        do {
            // Выбираем случайный процент из доступных
            const percentage = percentages[Math.floor(Math.random() * percentages.length)];
            
            // Для первых двух ответов гарантируем разнообразие
            if (i === 0) {
                // Первый ответ всегда противоположный основному направлению
                wrongAnswer = hasGreater 
                    ? Math.round(correctAnswer * (1 - percentage / 100))  // Меньше
                    : Math.round(correctAnswer * (1 + percentage / 100)); // Больше
            } else if (i === 1) {
                // Второй ответ всегда в основном направлении
                wrongAnswer = hasGreater 
                    ? Math.round(correctAnswer * (1 + percentage / 100))  // Больше
                    : Math.round(correctAnswer * (1 - percentage / 100)); // Меньше
            } else {
                // Третий ответ - случайный
                const isPositive = Math.random() < 0.5;
                wrongAnswer = isPositive 
                    ? Math.round(correctAnswer * (1 + percentage / 100))
                    : Math.round(correctAnswer * (1 - percentage / 100));
            }
            
            attempts++;
            
            // Проверяем, что число положительное и не равно правильному ответу
            if (wrongAnswer > 0 && wrongAnswer !== correctAnswer && !wrongAnswers.includes(wrongAnswer)) {
                break;
            }
            
            // Если не удалось найти подходящий ответ, пробуем другой подход
            if (attempts >= maxAttempts) {
                // Используем фиксированные проценты по порядку
                const fixedPercentage = percentages[i % percentages.length];
                const isPositive = i % 2 === 0;
                wrongAnswer = isPositive 
                    ? Math.round(correctAnswer * (1 + fixedPercentage / 100))
                    : Math.round(correctAnswer * (1 - fixedPercentage / 100));
                
                // Гарантируем положительное число
                if (wrongAnswer <= 0) {
                    wrongAnswer = Math.round(correctAnswer * (1 + fixedPercentage / 100));
                }
                break;
            }
        } while (true);
        
        wrongAnswers.push(wrongAnswer);
    }
    
    // Проверяем, что есть хотя бы один вариант больше и хотя бы один меньше
    const hasGreaterAnswer = wrongAnswers.some(ans => ans > correctAnswer);
    const hasLessAnswer = wrongAnswers.some(ans => ans < correctAnswer);
    
    // Если нет варианта больше, заменяем один из ответов
    if (!hasGreaterAnswer) {
        const percentage = percentages[Math.floor(Math.random() * percentages.length)];
        const greaterAnswer = Math.round(correctAnswer * (1 + percentage / 100));
        // Заменяем первый подходящий ответ
        for (let i = 0; i < wrongAnswers.length; i++) {
            if (wrongAnswers[i] < correctAnswer) {
                wrongAnswers[i] = greaterAnswer;
                break;
            }
        }
    }
    
    // Если нет варианта меньше, заменяем один из ответов
    if (!hasLessAnswer) {
        const percentage = percentages[Math.floor(Math.random() * percentages.length)];
        const lessAnswer = Math.round(correctAnswer * (1 - percentage / 100));
        // Гарантируем положительное число
        const finalLessAnswer = lessAnswer > 0 ? lessAnswer : Math.round(correctAnswer * 0.5);
        // Заменяем первый подходящий ответ
        for (let i = 0; i < wrongAnswers.length; i++) {
            if (wrongAnswers[i] > correctAnswer) {
                wrongAnswers[i] = finalLessAnswer;
                break;
            }
        }
    }
    
    return wrongAnswers;
}

// Функция для расчета очков по времени ответа
function calculateScoreByTime(timeInSeconds) {
    if (timeInSeconds <= 2) return 50;   // 0-2s: 50 очков
    if (timeInSeconds <= 4) return 35;   // 2-4s: 35 очков
    if (timeInSeconds <= 6) return 25;   // 4-6s: 25 очков
    if (timeInSeconds <= 8) return 10;   // 6-8s: 10 очков
    return 5;                            // >8s: 5 очков
}

// Функция для обновления отображения очков
function updateScoreDisplay() {
    document.getElementById('totalScore').textContent = totalScore;
}

function nextQuestion(){
    firstTry = true;
    const questionStr = generateQuestion();
    document.getElementById('question').textContent = questionStr;
    
    // Запоминаем время начала вопроса
    questionStartTime = Date.now();

    // Генерируем варианты ответов
    let answers = [currentAnswer];
    const wrongAnswers = generateWrongAnswers(currentAnswer);
    answers = answers.concat(wrongAnswers);
    answers = shuffle(answers);

    const answersDiv = document.getElementById('answers');
    answersDiv.innerHTML = '';
    answers.forEach(ans=>{
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.onclick = ()=>{
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            
            // Обновляем общее прошедшее время
            if (blitzMode) {
                totalElapsedTime = Math.floor((Date.now() - startTime) / 1000);
            }
            
            if(ans===currentAnswer){
                btn.classList.add('correct');
                if(firstTry) {
                    correctFirst++;
                    
                    // Рассчитываем время ответа и начисляем очки
                    const answerTime = (Date.now() - questionStartTime) / 1000; // время в секундах
                    const pointsEarned = calculateScoreByTime(answerTime);
                    totalScore += pointsEarned;
                    updateScoreDisplay();
                    
                    // Показываем сообщение о начисленных очках
                    const feedback = document.getElementById('timeFeedback');
                    feedback.textContent = `+${pointsEarned} очков`;
                    feedback.className = 'time-feedback time-bonus';
                    feedback.classList.remove('hidden');
                    
                    setTimeout(() => {
                        feedback.classList.add('hidden');
                    }, 1500);
                    
                    // Добавляем время за правильный ответ в блитц режиме
                    if (blitzMode) {
                        const bonusTime = parseInt(document.getElementById('bonusTime').value);
                        if (bonusTime > 0) {
                            timeLeft += bonusTime;
                            showTimeBonus(bonusTime);
                        }
                    }
                } else {
                    incorrect++;
                }
                document.getElementById('correctFirst').textContent = correctFirst;
                document.getElementById('incorrect').textContent = incorrect;
                updateProgressBar();
                setTimeout(nextQuestion,1000);
            }else{
                btn.classList.add('wrong');
                firstTry=false;
                // Отнимаем время за неправильный ответ в блитц режиме
                if (blitzMode) {
                    const penaltyTime = parseInt(document.getElementById('penaltyTime').value);
                    if (penaltyTime > 0) {
                        timeLeft = Math.max(0, timeLeft - penaltyTime);
                        showTimePenalty(penaltyTime);
                    }
                }
            }
        };
        answersDiv.appendChild(btn);
    });
}
</script>
</body>
</html>
