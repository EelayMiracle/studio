<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Пчёлы и цветы</title>
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#182230; }
    .topbar { position:fixed; top:0; left:0; right:0; height:54px; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:#ffffffcc; backdrop-filter: blur(6px); border-bottom:1px solid #d8dde7; z-index:10; }
    .title { font-weight:700; }
    .btn { background:#2b68e5; color:#fff; border:0; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover { opacity:.9; }

    .legend { position:fixed; top:54px; left:0; right:0; height:60px; display:flex; align-items:center; justify-content:center; gap:14px; padding:8px; background:#ffffffeb; border-bottom:1px solid #d8dde7; z-index:9; overflow-x:auto; }
    .legend-item { display:flex; align-items:center; gap:8px; background:#f6f8fe; border:1px solid #dbe3f7; border-radius:10px; padding:6px 10px; flex-shrink:0; }
    .legend-item img { width:28px; height:28px; object-fit:contain; }
    .legend-item .val { font-weight:700; }

    .canvas-wrap { position:absolute; top:114px; left:0; right:0; bottom:140px; display:flex; align-items:center; justify-content:center; padding:12px; box-sizing:border-box; }
    .stage { position:relative; background:#f7f7fa; border:1px solid #cfd6e6; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.12); overflow:hidden; background-image:url('grass.jpg'); background-size:cover; background-position:center; }
    canvas { width:100%; height:100%; display:block; }

    .counting-panel { position:fixed; bottom:0; left:0; right:0; height:140px; display:grid; align-items:center; justify-items:center; gap:8px; padding:12px 16px; background:#ffffff; border-top:1px solid #d8dde7; }
    .counting-panel { grid-template-rows: auto auto; }
    .counting-row { display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap; }
    .count-fields { display:flex; align-items:center; gap:12px; }
    .count-field { display:flex; align-items:center; gap:8px; background:#f6f8fe; border:1px solid #dbe3f7; border-radius:10px; padding:8px 12px; min-width:160px; flex-shrink:0; }
    .count-field.correct { border-color:#16a34a; background:#dcfce7; }
    .count-field.incorrect { border-color:#ef4444; background:#fee2e2; }
    .count-field input { width:70px; background:transparent; border:none; color:#182230; font-size:16px; text-align:center; outline:none; }
    .total-field { background:#f6f8fe; border:1px solid #dbe3f7; border-radius:10px; padding:8px 12px; min-width:140px; text-align:center; font-weight:700; }
    .total-field.correct { border-color:#16a34a; background:#dcfce7; }
    .total-field.incorrect { border-color:#ef4444; background:#fee2e2; }
    .check-btn { background:#2b68e5; color:#fff; border:0; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:700; }

    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20; background:rgba(0,0,0,0.35); padding:16px; }
    .panel { width:min(900px,96vw); max-height:92vh; overflow:auto; background:#ffffff; color:#182230; border:1px solid #d8dde7; border-radius:14px; padding:16px; box-shadow:0 12px 40px rgba(0,0,0,0.25); }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .field { display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; background:#f6f8fe; border:1px solid #dbe3f7; border-radius:10px; padding:10px; }
    .num { width:84px; padding:8px 10px; border-radius:8px; border:1px solid #c0c9e2; }
    .flowers { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .tile { background:#f6f8fe; border:1px solid #dbe3f7; border-radius:12px; padding:10px; display:grid; gap:6px; user-select:none; }
    .tile img { width:48px; height:48px; object-fit:contain; justify-self:center; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Пчёлы и цветы</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="btn-new" class="btn">Новая игра</button>
      <button id="btn-settings" class="btn" style="background:#50658f;">Настройки</button>
    </div>
  </div>

  <div id="legend" class="legend"></div>

  <div class="canvas-wrap">
    <div id="stage" class="stage">
      <canvas id="view"></canvas>
    </div>
  </div>

  <div class="counting-panel">
    <div class="counting-row">
      <div id="countFields" class="count-fields"></div>
    </div>
    <div class="counting-row">
      <div class="total-field" id="totalFieldAll">Пыльцы всего: <input id="inpTotalAll" type="number" min="0" max="9999" placeholder="?" style="width:70px; background:transparent; border:none; text-align:center;"></div>
      <div class="total-field" id="totalFieldBee1">У пчелы 1: <input id="inpBee1" type="number" min="0" max="9999" placeholder="?" style="width:70px; background:transparent; border:none; text-align:center;"></div>
      <div class="total-field" id="totalFieldBee2">У пчелы 2: <input id="inpBee2" type="number" min="0" max="9999" placeholder="?" style="width:70px; background:transparent; border:none; text-align:center;"></div>
      <div class="total-field" id="totalFieldRemain">Осталось на поле: <input id="inpRemain" type="number" min="0" max="9999" placeholder="?" style="width:70px; background:transparent; border:none; text-align:center;"></div>
      <div class="total-field" id="totalFieldBees">Всего у пчел: <input id="inpBees" type="number" min="0" max="9999" placeholder="?" style="width:70px; background:transparent; border:none; text-align:center;"></div>
      <button id="btn-check" class="check-btn">Проверить</button>
      <button id="btn-show-answers" class="check-btn" style="background:#16a34a;">Показать ответы</button>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="panel">
      <h3 style="margin:0 0 10px 0;">Настройки</h3>
      <div class="grid">
        <div class="field">
          <label>Сколько типов цветов участвует</label>
          <input id="participatingCount" class="num" type="number" min="1" max="7" value="4">
        </div>
        <div class="field">
          <label>Радиус элемента (px)</label>
          <input id="itemRadius" class="num" type="number" min="10" max="40" value="22">
        </div>
        <div class="field">
          <label>Доп. зазор (px)</label>
          <input id="extraGap" class="num" type="number" min="0" max="40" value="4">
        </div>
        <div class="field">
          <label>Мин. посещений пчелы</label>
          <input id="minVisits" class="num" type="number" min="0" max="50" value="3">
        </div>
        <div class="field">
          <label>Макс. посещений пчелы</label>
          <input id="maxVisits" class="num" type="number" min="0" max="50" value="7">
        </div>
        <div class="field">
          <label>Масштаб (%)</label>
          <input id="scalePercent" class="num" type="number" min="50" max="300" value="100">
        </div>
      </div>
      <h4 style="margin:12px 0 8px 0;">Выберите типы цветов и задайте мин/макс и значение пыльцы:</h4>
      <div id="flowerTiles" class="flowers"></div>
      <div class="panel-actions" style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
        <button id="btn-cancel" class="btn" style="background:#8e98ad;">Отмена</button>
        <button id="btn-apply" class="btn">Применить</button>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('view');
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const stage = document.getElementById('stage');
    const wrap = document.querySelector('.canvas-wrap');
    const legendEl = document.getElementById('legend');
    // Ширина левой зоны под пчёл и их миниатюры, куда нельзя ставить цветы
    const EXCLUDE_LEFT_PX = 200;
    // Параметры пчёл и миниатюр для расчётов зон
    const BEE_BASE_R = Math.round(28 * 1.5); // фикс радиус пчелы (px)
    const MINI_SIZE = 28; const MINI_GAP = 8;
    const GRID_W = 8*MINI_SIZE + 7*MINI_GAP; // ширина миниатюр в ряд
    const EXCLUDE_W = BEE_BASE_R*2 + 12 + GRID_W; // ширина зоны под пчелу + миниатюры
    const EXCLUDE_H = 160; // высота верхней зоны с пчёлами и миниатюрами

    // Кэш изображений
    const IMG_CACHE = new Map();
    function getCachedImage(src, onReady){
      let entry = IMG_CACHE.get(src);
      if (entry && entry.img && entry.loaded){
        if (onReady) onReady(entry.img);
        return entry.img;
      }
      if (!entry){
        const img = new Image();
        entry = { img, loaded:false, cbs: [] };
        IMG_CACHE.set(src, entry);
        img.onload = () => { entry.loaded = true; entry.cbs.forEach(cb=>cb(img)); entry.cbs = []; };
        img.onerror = () => { entry.loaded = false; entry.cbs = []; };
        img.src = src;
      }
      if (onReady) entry.cbs.push(onReady);
      return entry.img;
    }

    const overlay = document.getElementById('overlay');
    const flowerTiles = document.getElementById('flowerTiles');
    const ui = {
      participatingCount: document.getElementById('participatingCount'),
      itemRadius: document.getElementById('itemRadius'),
      extraGap: document.getElementById('extraGap'),
      minVisits: document.getElementById('minVisits'),
      maxVisits: document.getElementById('maxVisits'),
      scalePercent: document.getElementById('scalePercent'),
    };
    const btnNew = document.getElementById('btn-new');
    const btnSettings = document.getElementById('btn-settings');
    const btnApply = document.getElementById('btn-apply');
    const btnCancel = document.getElementById('btn-cancel');
    const btnCheck = document.getElementById('btn-check');
    const btnShowAnswers = document.getElementById('btn-show-answers');
    const countFields = document.getElementById('countFields');
    const totalAll = document.getElementById('totalFieldAll');
    const totalBee1 = document.getElementById('totalFieldBee1');
    const totalBee2 = document.getElementById('totalFieldBee2');
    const totalRemain = document.getElementById('totalFieldRemain');
    const totalBees = document.getElementById('totalFieldBees');
    const inpTotalAll = document.getElementById('inpTotalAll');
    const inpBee1 = document.getElementById('inpBee1');
    const inpBee2 = document.getElementById('inpBee2');
    const inpRemain = document.getElementById('inpRemain');
    const inpBees = document.getElementById('inpBees');

    function openSettings(){ overlay.style.display = 'flex'; }
    function closeSettings(){ overlay.style.display = 'none'; }

    function resizeCanvas(){
      const cont = wrap.getBoundingClientRect();
      const maxW = Math.max(200, cont.width - 24);
      const maxH = Math.max(200, cont.height - 24);
      const ratio = 16/9; let w = maxW; let h = w/ratio; if (h>maxH){ h=maxH; w=h*ratio; }
      stage.style.width = Math.floor(w) + 'px'; stage.style.height = Math.floor(h) + 'px';
      const rect = stage.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr); canvas.height = Math.floor(rect.height * dpr);
      canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawScene(lastState);
    }
    window.addEventListener('resize', resizeCanvas);

    // Данные
    const FLOWER_TYPES = [
      { id:'f1', name:'Цветок 1', src:'Без имени-1.png' },
      { id:'f2', name:'Цветок 2', src:'Без имени-2.png' },
      { id:'f3', name:'Цветок 3', src:'Без имени-3.png' },
      { id:'f4', name:'Цветок 4', src:'Без имени-4.png' },
      { id:'f5', name:'Цветок 5', src:'Без имени-5.png' },
      { id:'f6', name:'Цветок 6', src:'Без имени-6.png' },
      { id:'f7', name:'Цветок 7', src:'Без имени-7.png' },
    ];
    const BEES = [
      { id:'bee1', name:'Пчела 1', src:'bee1.png' },
      { id:'bee2', name:'Пчела 2', src:'bee2.png' },
    ];

    // Настройка по типам: выбран/ мин/макс/ значение пыльцы
    const perFlower = new Map(FLOWER_TYPES.map(f => [f.id, { selected:true, min:3, max:6, value:1 }]));

    function renderFlowerTiles(){
      flowerTiles.innerHTML = '';
      FLOWER_TYPES.forEach(f => {
        const tile = document.createElement('div'); tile.className='tile';
        const img = document.createElement('img'); img.src = f.src; img.alt = f.name; tile.appendChild(img);
        const name = document.createElement('div'); name.style.textAlign='center'; name.textContent = f.name; tile.appendChild(name);
        const row1 = document.createElement('div'); row1.style.display='grid'; row1.style.gridTemplateColumns='1fr 1fr'; row1.style.gap='6px';
        const minInput = document.createElement('input'); minInput.type='number'; minInput.className='num'; minInput.min='0'; minInput.max='200';
        const maxInput = document.createElement('input'); maxInput.type='number'; maxInput.className='num'; maxInput.min='0'; maxInput.max='200';
        const valInput = document.createElement('input'); valInput.type='number'; valInput.className='num'; valInput.min='0'; valInput.max='200'; valInput.style.gridColumn='span 2';
        const cur = perFlower.get(f.id) || {selected:true, min:1, max:3, value:1};
        minInput.value = String(cur.min); maxInput.value = String(cur.max); valInput.value = String(cur.value);
        minInput.addEventListener('input', ()=>{ const c=perFlower.get(f.id); c.min = Math.max(0, +minInput.value|0); if (c.max < c.min){ c.max = c.min; maxInput.value = String(c.max);} });
        maxInput.addEventListener('input', ()=>{ const c=perFlower.get(f.id); c.max = Math.max(0, +maxInput.value|0); if (c.max < c.min){ c.min = c.max; minInput.value = String(c.min);} });
        valInput.addEventListener('input', ()=>{ const c=perFlower.get(f.id); c.value = Math.max(0, +valInput.value|0); });
        row1.appendChild(minInput); row1.appendChild(maxInput); row1.appendChild(valInput);
        const sel = document.createElement('div'); sel.style.textAlign='center'; sel.style.marginTop='6px';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!cur.selected; chk.addEventListener('change', ()=>{ const c=perFlower.get(f.id); c.selected = chk.checked; });
        sel.append('Участвует ', chk);
        tile.appendChild(row1); tile.appendChild(sel);
        flowerTiles.appendChild(tile);
      });
    }

    // Helpers
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function distance(ax,ay,bx,by){ return Math.hypot(ax-bx, ay-by); }

    function computeBounds(itemRadius){
      const w = canvas.clientWidth, h = canvas.clientHeight;
      let left = itemRadius + 10; const right = w - itemRadius - 10;
      // Ограничиваем появление цветов только нижними 80% холста
      const top = Math.max(itemRadius + 10, h * 0.2); 
      const bottom = h - itemRadius - 10;
      // исключаем левую полосу для пчёл
      left = Math.max(left, EXCLUDE_LEFT_PX + itemRadius + 10);
      return {left,right,top,bottom};
    }

    function generatePositions(total, itemRadius, extraGap){
      const minGap = 2*itemRadius + extraGap;
      const bounds = computeBounds(itemRadius);
      const w = canvas.clientWidth, h = canvas.clientHeight;
      const pts = [];
      let tries = 0, maxTries = total * 400;
      let gap = minGap;
      while (pts.length < total && tries < maxTries){
        const x = randInt(bounds.left, bounds.right);
        const y = randInt(bounds.top, bounds.bottom);
        // запретные зоны: слева сверху и справа сверху
        const inLeftEx = (x < EXCLUDE_W) && (y < EXCLUDE_H);
        const inRightEx = (x > w - EXCLUDE_W) && (y < EXCLUDE_H);
        if (inLeftEx || inRightEx) { tries++; continue; }
        let ok = true;
        for (let i=0;i<pts.length;i++) { if (distance(pts[i].x, pts[i].y, x, y) < gap) { ok=false; break; } }
        if (ok) pts.push({x,y});
        tries++;
        if (tries % 1000 === 0 && gap > minGap*0.7) gap *= 0.95;
      }
      return pts;
    }

    // Состояние раунда
    let lastState = null;

    function buildAndDraw(){
      // Собираем активные цветы
      const selected = FLOWER_TYPES.filter(f => (perFlower.get(f.id)||{}).selected);
      const k = Math.min(selected.length, Math.max(1, (+ui.participatingCount.value|0)));
      const activeFlowers = selected.slice().sort(()=>Math.random()-0.5).slice(0,k);
      // Генерация количества по типам
      const countsByType = new Map();
      let totalFlowers = 0;
      activeFlowers.forEach(f => {
        const conf = perFlower.get(f.id);
        const n = randInt(conf.min, Math.max(conf.min, conf.max));
        countsByType.set(f.id, n); totalFlowers += n;
      });

      // Позиции цветов
      const scale = Math.max(0.5, (+ui.scalePercent.value||100)/100);
      const itemR = Math.max(4, Math.round((+ui.itemRadius.value|0) * scale));
      const extra = +ui.extraGap.value|0;
      const pts = generatePositions(totalFlowers, itemR*2, extra);
      const items = [];
      let idx = 0;
      activeFlowers.forEach(f => {
        const n = countsByType.get(f.id) || 0;
        for (let i=0;i<n && idx<pts.length;i++,idx++){
          items.push({ x: pts[idx].x, y: pts[idx].y, flowerId: f.id });
        }
      });

      // Легенда (значение пыльцы за тип)
      const legend = activeFlowers.map(f => ({ id:f.id, name:f.name, src:f.src, value:(perFlower.get(f.id)||{}).value|0 }));

      // Раздаём посещения пчёлам без пересечений
      const visitMin = +ui.minVisits.value|0; const visitMax = +ui.maxVisits.value|0;
      const pool = items.map((it, i)=>i); // индексы цветов
      const shuffle = arr=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
      shuffle(pool);
      const beeVisits = [];
      for (let b=0;b<BEES.length;b++){
        const need = Math.min(pool.length, randInt(visitMin, Math.max(visitMin, visitMax)));
        const picks = pool.splice(0, need);
        beeVisits.push(picks);
      }

      lastState = { activeFlowers, countsByType, items, legend, beeVisits, itemR };
      drawScene(lastState);
      renderLegend();
      renderAnswerPanel();
    }

    function drawScene(state){
      if (!state) return;
      const cont = wrap.getBoundingClientRect();
      const maxW = Math.max(200, cont.width - 24);
      const maxH = Math.max(200, cont.height - 24);
      const ratio = 16/9; let w = maxW; let h = w/ratio; if (h>maxH){ h=maxH; w=h*ratio; }
      const rect = { width:w, height:h };
      // canvas sizes are set in resizeCanvas already
      ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);

      // Цветы (без фона)
      state.items.forEach(it => {
        const f = FLOWER_TYPES.find(x=>x.id===it.flowerId);
        const r = state.itemR;
        const cx = it.x, cy = it.y;
        // Убираем белый фон у цветов на поле
        getCachedImage(f.src, (img)=>{ ctx.drawImage(img, cx - r, cy - r, 2*r, 2*r); });
      });

      // Пчёлы слева: покажем две пчелы и под ними миниатюры посещённых цветов
      const beeAreaX = 16, beeAreaY = 24;
      BEES.forEach((bee, i) => {
        const by = 16; // верхний край
        let bx;
        if (i === 0) {
          // пчела 1 слева
          bx = 16;
        } else {
          // пчела 2 справа
          bx = canvas.clientWidth - (BEE_BASE_R*2 + 16);
        }
        const r = Math.round(28 * 1.5); // фикс 150%
        ctx.save(); ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.beginPath(); ctx.arc(bx+r, by+r, r, 0, Math.PI*2); ctx.fill(); ctx.restore();
        getCachedImage(bee.src, (img)=>{ ctx.drawImage(img, bx, by, r*2, r*2); });
        // Миниатюры посещённых цветов
        const visits = (lastState?.beeVisits?.[i]||[]).map(idx => lastState.items[idx]);
        const mini = MINI_SIZE; const gap = MINI_GAP; const rowsY = by + 6;
        if (i === 0) {
          // пчела 1: миниатюры справа от неё
          const startX = bx + r*2 + 12; const startY = rowsY;
          visits.forEach((v, j) => {
            const ff = FLOWER_TYPES.find(x=>x.id===v.flowerId);
            const col = j % 8; const row = Math.floor(j / 8);
            const px = startX + col * (mini + gap);
            const py = startY + row * (mini + gap);
            ctx.save(); ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillRect(px-2, py-2, mini+4, mini+4); ctx.restore();
            getCachedImage(ff.src, (img)=>{ ctx.drawImage(img, px, py, mini, mini); });
          });
        } else {
          // пчела 2: миниатюры прижаты к пчеле и идут СПРАВА НАЛЕВО (8 в ряд)
          const startY = rowsY;
          const rightEdge = bx - 12; // правая граница сетки у самой пчелы
          visits.forEach((v, j) => {
            const ff = FLOWER_TYPES.find(x=>x.id===v.flowerId);
            const col = j % 8; const row = Math.floor(j / 8);
            const px = rightEdge - mini - col * (mini + gap);
            const py = startY + row * (mini + gap);
            ctx.save(); ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillRect(px-2, py-2, mini+4, mini+4); ctx.restore();
            getCachedImage(ff.src, (img)=>{ ctx.drawImage(img, px, py, mini, mini); });
          });
        }
      });
    }

    function renderLegend(){
      legendEl.innerHTML = '';
      if (!lastState) return;
      lastState.legend.forEach(l => {
        const div = document.createElement('div'); div.className = 'legend-item';
        const img = document.createElement('img'); img.src = l.src; img.alt = l.name;
        const val = document.createElement('div'); val.className = 'val'; val.textContent = String(l.value);
        div.appendChild(img); div.appendChild(document.createTextNode(' = ')); div.appendChild(val);
        legendEl.appendChild(div);
      });
    }

    function renderAnswerPanel(){
      countFields.innerHTML = '';
      if (!lastState) return;
      // пыльцы всего по каждому типу цветка (на поле)
      let sumAll = 0;
      lastState.activeFlowers.forEach(f => {
        const count = lastState.countsByType.get(f.id) || 0;
        const val = (perFlower.get(f.id)||{}).value|0;
        const totalType = count * val; sumAll += totalType;
        const field = document.createElement('div'); field.className='count-field'; field.dataset.type=f.id;
        const img = document.createElement('img'); img.src = f.src; img.style.width='28px'; img.style.height='28px'; img.style.objectFit='contain';
        const label = document.createElement('div'); label.textContent = 'Пыльцы всего'; label.style.fontSize='12px';
        const input = document.createElement('input'); input.type='number'; input.min='0'; input.max='9999'; input.placeholder='?'; input.dataset.correctValue = String(totalType);
        field.appendChild(img); field.appendChild(label); field.appendChild(input);
        countFields.appendChild(field);
      });
      // Totals
      const beePollen = [0,0];
      for (let b=0;b<BEES.length;b++){
        const visits = (lastState.beeVisits[b]||[]).map(idx => lastState.items[idx]);
        visits.forEach(v => { const val = (perFlower.get(v.flowerId)||{}).value|0; beePollen[b]+=val; });
      }
      const collected = beePollen[0] + beePollen[1];
      const remain = Math.max(0, sumAll - collected);
      inpTotalAll.value = ''; inpBee1.value=''; inpBee2.value=''; inpRemain.value=''; inpBees.value='';
      totalAll.dataset.correctValue = String(sumAll);
      totalBee1.dataset.correctValue = String(beePollen[0]);
      totalBee2.dataset.correctValue = String(beePollen[1]);
      totalRemain.dataset.correctValue = String(remain);
      totalBees.dataset.correctValue = String(collected);
      // сброс подсветки
      document.querySelectorAll('.count-field, .total-field').forEach(el => el.classList.remove('correct','incorrect'));
    }

    function checkAnswers(){
      let allCorrect = true;
      document.querySelectorAll('.count-field').forEach(field => {
        const input = field.querySelector('input');
        const user = +input.value||0; const correct = +input.dataset.correctValue||0;
        if (user===correct){ field.classList.remove('incorrect'); field.classList.add('correct'); }
        else { field.classList.remove('correct'); field.classList.add('incorrect'); allCorrect=false; }
      });
      const totalPairs = [ [inpTotalAll, totalAll], [inpBee1, totalBee1], [inpBee2, totalBee2], [inpRemain, totalRemain], [inpBees, totalBees] ];
      totalPairs.forEach(([inp, box])=>{
        const user=+inp.value||0, correct=+box.dataset.correctValue||0;
        if (user===correct){ box.classList.remove('incorrect'); box.classList.add('correct'); }
        else { box.classList.remove('correct'); box.classList.add('incorrect'); allCorrect=false; }
      });
      // без alert — только подсветка
    }

    function showAnswers(){
      // Заполняем все поля правильными ответами
      document.querySelectorAll('.count-field').forEach(field => {
        const input = field.querySelector('input');
        const correct = +input.dataset.correctValue||0;
        input.value = String(correct);
      });
      const totalPairs = [ [inpTotalAll, totalAll], [inpBee1, totalBee1], [inpBee2, totalBee2], [inpRemain, totalRemain], [inpBees, totalBees] ];
      totalPairs.forEach(([inp, box])=>{
        const correct = +box.dataset.correctValue||0;
        inp.value = String(correct);
      });
      // Подсвечиваем все как правильные
      document.querySelectorAll('.count-field, .total-field').forEach(el => {
        el.classList.remove('incorrect');
        el.classList.add('correct');
      });
    }

    // События
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); });
    btnNew.addEventListener('click', ()=>{ closeSettings(); buildAndDraw(); });
    btnSettings.addEventListener('click', ()=>{ openSettings(); renderFlowerTiles(); });
    btnCancel.addEventListener('click', ()=> closeSettings());
    btnApply.addEventListener('click', ()=>{ closeSettings(); buildAndDraw(); });
    btnCheck.addEventListener('click', checkAnswers);
    btnShowAnswers.addEventListener('click', showAnswers);

    // Init
    renderFlowerTiles();
    resizeCanvas();
    buildAndDraw();
  </script>
</body>
</html>


